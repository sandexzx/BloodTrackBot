#!/bin/bash

# BloodTrackBot Automated Deploy Script
# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ñ Ñ‚ÐµÐ»ÐµÐ³Ñ€Ð°Ð¼-Ð±Ð¾Ñ‚Ð° Ð½Ð° Ubuntu 24.04
# ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ ÐºÐ°Ðº Ð¿ÐµÑ€Ð²Ð¾Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½ÑƒÑŽ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ, Ñ‚Ð°Ðº Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ

set -e  # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐµ

# ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ
PROJECT_NAME="bloodtrackbot"
REPO_URL="https://github.com/sandexzx/BloodTrackBot.git"
APP_USER="botuser"
APP_DIR="/opt/$PROJECT_NAME"
VENV_DIR="$APP_DIR/venv"
SERVICE_NAME="$PROJECT_NAME"
PYTHON_VERSION="3.12"

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
log() {
    echo -e "${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Ð—Ð°Ð¿Ñ€Ð¾Ñ Ñ‚Ð¾ÐºÐµÐ½Ð° Ð±Ð¾Ñ‚Ð°
get_bot_token() {
    local current_token=""
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ ÑƒÐ¶Ðµ Ñ‚Ð¾ÐºÐµÐ½ Ð² .env Ñ„Ð°Ð¹Ð»Ðµ
    if [[ -f "$APP_DIR/.env" ]]; then
        current_token=$(grep "BOT_TOKEN=" "$APP_DIR/.env" 2>/dev/null | cut -d'=' -f2 | tr -d '"' | tr -d "'" | xargs)
        if [[ -n "$current_token" && "$current_token" != "your_bot_token_here" ]]; then
            echo
            log "ÐÐ°Ð¹Ð´ÐµÐ½ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ Ñ‚Ð¾ÐºÐµÐ½ Ð±Ð¾Ñ‚Ð°: ${current_token:0:10}..."
            read -p "Ð¥Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ Ñ‚Ð¾ÐºÐµÐ½? (y/n): " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                BOT_TOKEN="$current_token"
                return
            fi
        fi
    fi
    
    echo
    log "ÐÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ ÑƒÐºÐ°Ð·Ð°Ñ‚ÑŒ Ñ‚Ð¾ÐºÐµÐ½ Telegram Ð±Ð¾Ñ‚Ð°"
    echo "ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ñ‚Ð¾ÐºÐµÐ½ Ð¼Ð¾Ð¶Ð½Ð¾ Ñƒ @BotFather Ð² Telegram"
    echo
    
    while true; do
        read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚Ð¾ÐºÐµÐ½ Ð±Ð¾Ñ‚Ð°: " BOT_TOKEN
        
        # Ð‘Ð°Ð·Ð¾Ð²Ð°Ñ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ñ‚Ð¾ÐºÐµÐ½Ð° (Ð´Ð¾Ð»Ð¶ÐµÐ½ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ñ†Ð¸Ñ„Ñ€Ñ‹ Ð¸ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ ':')
        if [[ $BOT_TOKEN =~ ^[0-9]+:[a-zA-Z0-9_-]+$ ]]; then
            break
        else
            error "ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ñ‚Ð¾ÐºÐµÐ½Ð°. Ð¢Ð¾ÐºÐµÐ½ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¸Ð¼ÐµÑ‚ÑŒ Ð²Ð¸Ð´: 123456789:AAABBBCCC..."
            echo "ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ðµ Ñ€Ð°Ð·."
        fi
    done
    
    success "Ð¢Ð¾ÐºÐµÐ½ Ð¿Ñ€Ð¸Ð½ÑÑ‚"
}
check_root() {
    if [[ $EUID -ne 0 ]]; then
        error "Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð¾Ñ‚ Ð¸Ð¼ÐµÐ½Ð¸ root"
        exit 1
    fi
}

# ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
install_system_dependencies() {
    log "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
    
    apt update
    apt install -y \
        python$PYTHON_VERSION \
        python$PYTHON_VERSION-venv \
        python$PYTHON_VERSION-dev \
        python3-pip \
        git \
        curl \
        wget \
        nano \
        htop \
        sqlite3 \
        supervisor
    
    success "Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
}

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
create_app_user() {
    if id "$APP_USER" &>/dev/null; then
        warning "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ $APP_USER ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
    else
        log "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ $APP_USER..."
        useradd -r -s /bin/false -d $APP_DIR $APP_USER
        success "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ $APP_USER ÑÐ¾Ð·Ð´Ð°Ð½"
    fi
}

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
setup_directories() {
    log "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
    
    # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹
    mkdir -p $APP_DIR
    mkdir -p $APP_DIR/logs
    
    # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
    chown -R $APP_USER:$APP_USER $APP_DIR
    chmod 755 $APP_DIR
    
    success "Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹"
}

# ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ¶Ð¸Ð¼Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ (ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°/Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ)
check_deployment_mode() {
    if [[ -d "$APP_DIR/.git" ]]; then
        echo "update"
    else
        echo "install"
    fi
}

# ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
setup_repository() {
    local mode=$1
    
    if [[ "$mode" == "update" ]]; then
        log "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ..."
        cd $APP_DIR
        sudo -u $APP_USER git fetch origin
        sudo -u $APP_USER git reset --hard origin/main
        success "Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½"
    else
        log "ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ..."
        if [[ -d "$APP_DIR" ]]; then
            rm -rf $APP_DIR/*
        fi
        sudo -u $APP_USER git clone $REPO_URL $APP_DIR
        success "Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ ÑÐºÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½"
    fi
}

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Python
setup_python_environment() {
    local mode=$1
    
    log "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Python Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
    
    cd $APP_DIR
    
    if [[ "$mode" == "update" && -d "$VENV_DIR" ]]; then
        log "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
        sudo -u $APP_USER $VENV_DIR/bin/pip install --upgrade pip
        sudo -u $APP_USER $VENV_DIR/bin/pip install -r requirements.txt --upgrade
    else
        log "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
        # Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ€Ð¾Ð³Ð¾ venv ÐµÑÐ»Ð¸ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
        [[ -d "$VENV_DIR" ]] && rm -rf $VENV_DIR
        
        # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
        sudo -u $APP_USER python$PYTHON_VERSION -m venv $VENV_DIR
        
        # ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ pip
        sudo -u $APP_USER $VENV_DIR/bin/pip install --upgrade pip
        
        # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
        sudo -u $APP_USER $VENV_DIR/bin/pip install -r requirements.txt
    fi
    
    success "Python Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¾"
}

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ (.env Ñ„Ð°Ð¹Ð»)
setup_configuration() {
    log "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸..."
    
    # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°
    cat > $APP_DIR/.env << EOF
# Telegram Bot Configuration
BOT_TOKEN=$BOT_TOKEN

# Database Configuration (SQLite Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ)
# ÐŸÑƒÑ‚ÑŒ Ðº Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð±ÑƒÐ´ÐµÑ‚: $APP_DIR/blood_pressure.db

# Logging Configuration
LOG_LEVEL=INFO
EOF
    
    chown $APP_USER:$APP_USER $APP_DIR/.env
    chmod 600 $APP_DIR/.env
    
    success "ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð° Ñ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð¼ Ð±Ð¾Ñ‚Ð°"
}

# Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
setup_database() {
    log "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
    
    cd $APP_DIR
    
    # Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… SQLite Ð±ÑƒÐ´ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½Ð° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿Ñ€Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ð¼ Ð·Ð°Ð¿ÑƒÑÐºÐµ
    # Ð£Ð±ÐµÐ¶Ð´Ð°ÐµÐ¼ÑÑ, Ñ‡Ñ‚Ð¾ Ñƒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ÐµÑÑ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° Ð·Ð°Ð¿Ð¸ÑÑŒ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
    chown $APP_USER:$APP_USER $APP_DIR
    chmod 755 $APP_DIR
    
    success "Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð°"
}

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd ÑÐµÑ€Ð²Ð¸ÑÐ°
create_systemd_service() {
    log "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd ÑÐµÑ€Ð²Ð¸ÑÐ°..."
    
    cat > /etc/systemd/system/$SERVICE_NAME.service << EOF
[Unit]
Description=BloodTrack Telegram Bot
After=network.target
Wants=network.target

[Service]
Type=simple
User=$APP_USER
Group=$APP_USER
WorkingDirectory=$APP_DIR
Environment=PATH=$VENV_DIR/bin
ExecStart=$VENV_DIR/bin/python bot.py
Restart=always
RestartSec=5
StandardOutput=journal
StandardError=journal
SyslogIdentifier=$SERVICE_NAME

# Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ
NoNewPrivileges=yes
PrivateTmp=yes
ProtectSystem=strict
ProtectHome=yes
ReadWritePaths=$APP_DIR

# ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²
LimitNOFILE=65536
MemoryMax=512M

[Install]
WantedBy=multi-user.target
EOF

    # ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° systemd Ð¸ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ°
    systemctl daemon-reload
    systemctl enable $SERVICE_NAME
    
    success "Systemd ÑÐµÑ€Ð²Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½"
}

# Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð¼
manage_service() {
    local mode=$1
    
    if [[ "$mode" == "update" ]]; then
        log "ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ°..."
        if systemctl is-active --quiet $SERVICE_NAME; then
            systemctl restart $SERVICE_NAME
        else
            systemctl start $SERVICE_NAME
        fi
    else
        log "Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ°..."
        systemctl start $SERVICE_NAME
    fi
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
    sleep 3
    if systemctl is-active --quiet $SERVICE_NAME; then
        success "Ð¡ÐµÑ€Ð²Ð¸Ñ $SERVICE_NAME ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½"
    else
        error "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÑÐµÑ€Ð²Ð¸Ñ $SERVICE_NAME"
        systemctl status $SERVICE_NAME --no-pager
        exit 1
    fi
}

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
setup_logging() {
    log "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ..."
    
    # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð²
    mkdir -p /var/log/$SERVICE_NAME
    chown $APP_USER:$APP_USER /var/log/$SERVICE_NAME
    
    # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° logrotate
    cat > /etc/logrotate.d/$SERVICE_NAME << EOF
/var/log/$SERVICE_NAME/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 $APP_USER $APP_USER
    postrotate
        systemctl reload $SERVICE_NAME
    endscript
}
EOF
    
    success "Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¾"
}

# Ð’Ñ‹Ð²Ð¾Ð´ ÑÐ¿Ñ€Ð°Ð²ÐºÐ¸ Ð¿Ð¾ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸ÑŽ
show_management_info() {
    echo
    echo "=================================="
    echo "ðŸš€ Ð”Ð•ÐŸÐ›ÐžÐ™ Ð—ÐÐ’Ð•Ð Ð¨Ð•Ð Ð£Ð¡ÐŸÐ•Ð¨ÐÐž!"
    echo "=================================="
    echo
    echo "ðŸ“‹ Ð£ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð• Ð‘ÐžÐ¢ÐžÐœ:"
    echo "â”œâ”€â”€ Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:           systemctl status $SERVICE_NAME"
    echo "â”œâ”€â”€ Ð—Ð°Ð¿ÑƒÑÐº:           systemctl start $SERVICE_NAME"  
    echo "â”œâ”€â”€ ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°:        systemctl stop $SERVICE_NAME"
    echo "â”œâ”€â”€ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº:       systemctl restart $SERVICE_NAME"
    echo "â”œâ”€â”€ ÐÐ²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº Ð’ÐšÐ›:   systemctl enable $SERVICE_NAME"
    echo "â””â”€â”€ ÐÐ²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº Ð’Ð«ÐšÐ›:  systemctl disable $SERVICE_NAME"
    echo
    echo "ðŸ“Š Ð›ÐžÐ“Ð˜ Ð˜ ÐœÐžÐÐ˜Ð¢ÐžÐ Ð˜ÐÐ“:"
    echo "â”œâ”€â”€ ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð»Ð¾Ð³Ð¾Ð²:   journalctl -u $SERVICE_NAME -f"
    echo "â”œâ”€â”€ Ð›Ð¾Ð³Ð¸ Ð·Ð° ÑÐµÐ³Ð¾Ð´Ð½Ñ:  journalctl -u $SERVICE_NAME --since today"
    echo "â””â”€â”€ ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð»Ð¾Ð³Ð¸:   journalctl -u $SERVICE_NAME -n 50"
    echo
    echo "ðŸ“ Ð¤ÐÐ™Ð›Ð« ÐŸÐ ÐžÐ•ÐšÐ¢Ð:"
    echo "â”œâ”€â”€ ÐšÐ¾Ð´ Ð±Ð¾Ñ‚Ð°:         $APP_DIR"
    echo "â”œâ”€â”€ ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ:     $APP_DIR/.env"
    echo "â”œâ”€â”€ Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…:      $APP_DIR/blood_pressure.db"
    echo "â””â”€â”€ Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€.: $VENV_DIR"
    echo
    echo "âš ï¸  Ð’ÐÐ–ÐÐ«Ð• ÐÐÐŸÐžÐœÐ˜ÐÐÐÐ˜Ð¯:"
    echo "â”œâ”€â”€ Ð¢Ð¾ÐºÐµÐ½ Ð±Ð¾Ñ‚Ð° ÑƒÐ¶Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½ Ð²: $APP_DIR/.env"
    echo "â”œâ”€â”€ Ð”Ð»Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ñ‚Ð¾ÐºÐµÐ½Ð°: Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾"
    echo "â””â”€â”€ ÐŸÐ¾ÑÐ»Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ .env: systemctl restart $SERVICE_NAME"
    echo
    echo "ðŸ”„ Ð”Ð›Ð¯ ÐžÐ‘ÐÐžÐ’Ð›Ð•ÐÐ˜Ð¯ Ð‘ÐžÐ¢Ð:"
    echo "â””â”€â”€ ÐŸÑ€Ð¾ÑÑ‚Ð¾ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÑ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾"
    echo
}

# ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ
main() {
    echo "ðŸš€ BloodTrackBot Deploy Script"
    echo "=============================="
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð°Ð² root
    check_root
    
    # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ¶Ð¸Ð¼Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹
    local deployment_mode=$(check_deployment_mode)
    
    if [[ "$deployment_mode" == "update" ]]; then
        log "Ð ÐµÐ¶Ð¸Ð¼: ÐžÐ‘ÐÐžÐ’Ð›Ð•ÐÐ˜Ð• ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ¹ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸"
    else
        log "Ð ÐµÐ¶Ð¸Ð¼: ÐŸÐ•Ð Ð’ÐžÐÐÐ§ÐÐ›Ð¬ÐÐÐ¯ Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ"
    fi
    
    # Ð—Ð°Ð¿Ñ€Ð¾Ñ Ñ‚Ð¾ÐºÐµÐ½Ð° Ð±Ð¾Ñ‚Ð°
    get_bot_token
    
    # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ ÑˆÐ°Ð³Ð¾Ð² Ð´ÐµÐ¿Ð»Ð¾Ñ
    if [[ "$deployment_mode" == "install" ]]; then
        install_system_dependencies
        create_app_user
        setup_directories
    fi
    
    setup_repository $deployment_mode
    setup_python_environment $deployment_mode
    setup_configuration
    setup_database
    
    if [[ "$deployment_mode" == "install" ]]; then
        create_systemd_service
        setup_logging
    fi
    
    manage_service $deployment_mode
    
    # Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°
    sleep 2
    if systemctl is-active --quiet $SERVICE_NAME; then
        show_management_info
    else
        error "Ð§Ñ‚Ð¾-Ñ‚Ð¾ Ð¿Ð¾ÑˆÐ»Ð¾ Ð½Ðµ Ñ‚Ð°Ðº. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸:"
        echo "journalctl -u $SERVICE_NAME -n 20"
        exit 1
    fi
}

# ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°Ð½Ð¸Ñ
trap 'error "Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¿Ñ€ÐµÑ€Ð²Ð°Ð½ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼"; exit 1' INT

# Ð—Ð°Ð¿ÑƒÑÐº Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸
main "$@"